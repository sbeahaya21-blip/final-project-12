<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Invoice Parser (test fixture)</title>
  <style>
    .invoice-upload, .invoice-detail { max-width: 1000px; margin: 0 auto; }
    .upload-zone { border: 2px dashed #ccc; padding: 3rem; text-align: center; cursor: pointer; }
    .upload-zone.processing { opacity: 0.7; }
    .error-message { background: #fff5f5; padding: 1rem; margin: 1rem 0; color: #c33; }
    .analysis-results { margin-top: 2rem; }
    .result-card { background: #f9fafb; padding: 1.5rem; border-radius: 6px; border-left: 4px solid #10b981; }
    .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .risk-badge { padding: 0.375rem 0.75rem; border-radius: 4px; font-weight: 500; }
    .risk-badge.low { background: #d1fae5; color: #065f46; }
    .risk-score { font-size: 1.5rem; font-weight: bold; margin: 1rem 0; }
    .explanation-box { background: #f3f4f6; padding: 1rem; margin: 1rem 0; border-radius: 6px; }
    .details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1rem 0; }
    .detail-item { display: flex; flex-direction: column; gap: 0.25rem; }
    .detail-value { font-size: 1.1rem; color: #333; font-weight: 600; }
    .action-buttons { display: flex; gap: 1rem; margin-top: 1.5rem; }
    .btn { padding: 0.5rem 1rem; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; }
    .btn-primary { background: #3b82f6; color: white; }
    .btn-secondary { background: #e5e7eb; color: #333; }
    .invoice-detail .invoice-card { background: #f9fafb; padding: 1.5rem; margin-top: 1rem; border-radius: 8px; }
    .submitted-status { padding: 0.5rem 1rem; background: #d1fae5; color: #065f46; border-radius: 6px; font-weight: 500; }
    .erpnext-name { margin-left: 0.25rem; }
    .analysis-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .risk-badge-large { padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600; }
    #detail-view, #upload-view { display: none; }
    #detail-view.visible, #upload-view.visible { display: block; }
    .loading-container { text-align: center; padding: 2rem; }
  </style>
</head>
<body>
  <div id="upload-view" class="visible">
    <div class="invoice-upload">
      <div class="upload-header"><h1>Upload Invoice</h1><p class="subtitle">Upload an invoice to detect anomalies</p></div>
      <div class="upload-zone" id="upload-zone">
        <div class="upload-content">
          <p class="upload-text">Drag and drop or click to browse</p>
          <label for="file-input" class="upload-button">Choose File</label>
          <input id="file-input" type="file" accept=".pdf,.jpg,.jpeg,.png,.txt" style="display:none" />
        </div>
      </div>
      <div id="upload-error" class="error-message" style="display:none"></div>
      <div id="analysis-results" class="analysis-results" style="display:none"></div>
    </div>
  </div>
  <div id="detail-view" class="invoice-detail">
    <div class="detail-header">
      <button type="button" class="btn btn-secondary" id="back-to-list">&#8592; Back to List</button>
      <div class="header-actions">
        <span id="submitted-status" class="submitted-status" style="display:none"></span>
        <button type="button" class="btn btn-success" id="submit-erpnext">&#128230; Submit to ERPNext</button>
      </div>
    </div>
    <div id="detail-error" class="error-message" style="display:none"></div>
    <div id="detail-loading" class="loading-container">Loading invoice...</div>
    <div id="detail-content" class="detail-content" style="display:none">
      <div class="invoice-card" id="invoice-card">
        <div class="analysis-section" id="detail-analysis"></div>
        <div class="explanation-box" id="detail-explanation"><h3>Explanation</h3><p id="detail-explanation-text"></p></div>
      </div>
    </div>
  </div>
  <script>
    (function() {
      var API_BASE = 'http://localhost:8000';
      function getPathId() { var m = location.pathname.match(/^\/invoices\/([^/]+)/); return m ? m[1] : null; }
      function showUpload() { document.getElementById('upload-view').classList.add('visible'); document.getElementById('detail-view').classList.remove('visible'); }
      function showDetail() { document.getElementById('upload-view').classList.remove('visible'); document.getElementById('detail-view').classList.add('visible'); }
      function renderUploadResults(data) {
        var inv = data.parsed_data || {};
        var riskClass = (data.risk_score >= 70) ? 'high' : (data.risk_score >= 50) ? 'medium' : 'low';
        var riskLabel = data.is_suspicious ? '\u26a0 SUSPICIOUS' : '\u2713 SAFE';
        var items = (inv.items || []).map(function(i){ return '<tr><td>'+(i.name||'')+'</td><td>'+i.quantity+'</td><td>$'+(i.unit_price||0).toFixed(2)+'</td><td>$'+(i.total_price||0).toFixed(2)+'</td></tr>'; }).join('');
        var html = '<div class="result-card '+(data.is_suspicious?'suspicious':'safe')+'"><div class="result-header"><h2>Analysis Results</h2><div class="risk-badge '+riskClass+'">'+riskLabel+'</div></div>'+
          '<div class="risk-score '+riskClass+'">Risk Score: '+(data.risk_score!=null?data.risk_score:0)+'/100</div>'+
          '<div class="explanation-box"><h3>Explanation</h3><p>'+(data.anomaly_explanation||'').replace(/</g,'&lt;')+'</p></div>'+
          '<div class="invoice-details"><h3>Invoice Details</h3><div class="details-grid">'+
          '<div class="detail-item"><span class="detail-label">Vendor:</span><span class="detail-value">'+(inv.vendor_name||'')+'</span></div>'+
          '<div class="detail-item"><span class="detail-label">Invoice #:</span><span class="detail-value">'+(inv.invoice_number||'')+'</span></div>'+
          '</div><div class="action-buttons"><button type="button" class="btn btn-primary" data-invoice-id="'+(data.id||'')+'">View Details</button><button type="button" class="btn btn-secondary" id="upload-another-btn">Upload Another</button></div></div></div>';
        var el = document.getElementById('analysis-results'); el.innerHTML = html; el.style.display = 'block';
        document.getElementById('upload-error').style.display = 'none';
        el.querySelector('[data-invoice-id]').onclick = function(){ location.href = '/invoices/' + this.getAttribute('data-invoice-id'); };
        document.getElementById('upload-another-btn').onclick = function(){ el.style.display = 'none'; el.innerHTML = ''; document.getElementById('file-input').value = ''; };
      }
      function showUploadError(msg) { var el = document.getElementById('upload-error'); el.innerHTML = '<strong>Error:</strong> ' + (msg || 'Unknown'); el.style.display = 'block'; document.getElementById('analysis-results').style.display = 'none'; }
      var zone = document.getElementById('upload-zone'); var fileInput = document.getElementById('file-input');
      zone.onclick = function(e) { if (e.target !== fileInput) fileInput.click(); };
      zone.ondragover = function(e) { e.preventDefault(); zone.classList.add('dragging'); };
      zone.ondragleave = function(e) { e.preventDefault(); zone.classList.remove('dragging'); };
      zone.ondrop = function(e) { e.preventDefault(); zone.classList.remove('dragging'); var f = e.dataTransfer && e.dataTransfer.files[0]; if (f) doUpload(f); };
      fileInput.onchange = function() { var f = fileInput.files && fileInput.files[0]; if (f) doUpload(f); };
      function doUpload(file) {
        zone.classList.add('processing'); zone.querySelector('.upload-text').textContent = 'Processing...';
        var fd = new FormData(); fd.append('file', file);
        fetch(API_BASE + '/api/invoices/upload', { method: 'POST', body: fd }).then(function(r){ if (!r.ok) return r.json().then(function(d){ throw new Error(d.detail || d.message || r.statusText); }); return r.json(); })
          .then(function(data){ zone.classList.remove('processing'); zone.querySelector('.upload-text').textContent = 'Drag and drop or click to browse'; renderUploadResults(data); })
          .catch(function(err){ zone.classList.remove('processing'); zone.querySelector('.upload-text').textContent = 'Drag and drop or click to browse'; showUploadError(err.message); });
      }
      document.getElementById('back-to-list').onclick = function() { location.href = '/'; };
      document.getElementById('submit-erpnext').onclick = function() {
        var id = getPathId(); if (!id || !window._detailInvoice) return;
        if (!window.confirm('Are you sure you want to submit this invoice to ERPNext?')) return;
        var btn = this; btn.disabled = true; btn.textContent = 'Submitting...';
        fetch(API_BASE + '/api/invoices/' + id + '/submit-to-erpnext', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: '{}' }).then(function(r){ if (!r.ok) return r.json().then(function(d){ throw new Error(d.detail || d.message); }); return r.json(); })
          .then(function(data){ window._detailInvoice = data; var st = document.getElementById('submitted-status'); st.style.display = 'inline-block'; st.innerHTML = '\u2713 Submitted to ERPNext' + (data.erpnext_invoice_name ? ' <span class="erpnext-name">(' + data.erpnext_invoice_name + ')</span>' : ''); btn.style.display = 'none'; btn.disabled = false; if (window.alert) window.alert('Submitted!'); })
          .catch(function(err){ document.getElementById('detail-error').style.display = 'block'; document.getElementById('detail-error').innerHTML = '<strong>Error:</strong> ' + err.message; btn.disabled = false; btn.textContent = 'Submit to ERPNext'; });
      };
      function renderDetail(invoice) {
        window._detailInvoice = invoice;
        document.getElementById('detail-loading').style.display = 'none'; document.getElementById('detail-content').style.display = 'block';
        document.getElementById('detail-explanation-text').textContent = invoice.anomaly_explanation || '';
        if (invoice.risk_score != null) { var rc = invoice.risk_score >= 70 ? 'high' : invoice.risk_score >= 50 ? 'medium' : 'low'; document.getElementById('detail-analysis').innerHTML = '<div class="analysis-header"><h2>Analysis Results</h2><div class="risk-badge-large '+rc+'">Risk Score: '+invoice.risk_score+'/100</div></div>'; document.getElementById('detail-analysis').style.display = 'block'; }
        if (invoice.submitted_to_erpnext) { var st = document.getElementById('submitted-status'); st.style.display = 'inline-block'; st.innerHTML = '\u2713 Submitted to ERPNext' + (invoice.erpnext_invoice_name ? ' <span class="erpnext-name">(' + invoice.erpnext_invoice_name + ')</span>' : ''); document.getElementById('submit-erpnext').style.display = 'none'; }
      }
      function loadDetail(id) {
        showDetail(); document.getElementById('detail-loading').style.display = 'block'; document.getElementById('detail-content').style.display = 'none'; document.getElementById('detail-error').style.display = 'none'; document.getElementById('submitted-status').style.display = 'none'; document.getElementById('submit-erpnext').style.display = 'inline-block'; document.getElementById('submit-erpnext').textContent = 'Submit to ERPNext';
        fetch(API_BASE + '/api/invoices/' + encodeURIComponent(id)).then(function(r){ if (!r.ok) return r.json().then(function(d){ throw new Error(d.detail || d.message); }); return r.json(); }).then(renderDetail).catch(function(err){ document.getElementById('detail-loading').style.display = 'none'; document.getElementById('detail-error').style.display = 'block'; document.getElementById('detail-error').innerHTML = '<strong>Error:</strong> ' + err.message; });
      }
      if (location.pathname === '/' || location.pathname === '') showUpload(); else { var id = getPathId(); if (id) loadDetail(id); else showUpload(); }
    })();
  </script>
</body>
</html>
