<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Invoice Parser (test fixture)</title>
  <style>
    .invoice-upload, .invoice-detail { max-width: 1000px; margin: 0 auto; }
    .upload-zone { border: 2px dashed #ccc; border-radius: 6px; padding: 3rem; text-align: center; cursor: pointer; }
    .upload-zone.processing { opacity: 0.7; cursor: not-allowed; }
    .error-message { background: #fff5f5; border: 2px solid #fcc; padding: 1rem; border-radius: 8px; margin: 1rem 0; color: #c33; }
    .analysis-results { margin-top: 2rem; }
    .result-card { background: #f9fafb; border-radius: 6px; padding: 1.5rem; border-left: 4px solid #10b981; }
    .result-card.suspicious { border-left-color: #ef4444; background: #fff5f5; }
    .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .risk-badge { padding: 0.375rem 0.75rem; border-radius: 4px; font-weight: 500; }
    .risk-badge.low { background: #d1fae5; color: #065f46; }
    .risk-badge.medium { background: #fef3c7; color: #92400e; }
    .risk-badge.high { background: #fee2e2; color: #b91c1c; }
    .risk-score { font-size: 1.5rem; font-weight: bold; margin: 1rem 0; text-align: center; }
    .explanation-box { background: #f3f4f6; padding: 1rem; border-radius: 6px; margin: 1rem 0; }
    .details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1rem 0; }
    .detail-item { display: flex; flex-direction: column; gap: 0.25rem; }
    .detail-label { font-size: 0.85rem; color: #666; }
    .detail-value { font-size: 1.1rem; color: #333; font-weight: 600; }
    .action-buttons { display: flex; gap: 1rem; margin-top: 1.5rem; flex-wrap: wrap; }
    .btn { padding: 0.5rem 1rem; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; }
    .btn-primary { background: #3b82f6; color: white; }
    .btn-secondary { background: #e5e7eb; color: #333; }
    .invoice-detail .invoice-card { background: #f9fafb; border-radius: 8px; padding: 1.5rem; margin-top: 1rem; }
    .submitted-status { padding: 0.5rem 1rem; background: #d1fae5; color: #065f46; border-radius: 6px; font-weight: 500; }
    .erpnext-name { margin-left: 0.25rem; }
    .analysis-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .risk-badge-large { padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600; }
    #detail-view, #upload-view { display: none; }
    #detail-view.visible, #upload-view.visible { display: block; }
    .loading-container { text-align: center; padding: 2rem; }
  </style>
</head>
<body>
  <div id="upload-view" class="visible">
    <div class="invoice-upload">
      <div class="upload-header">
        <h1>Upload Invoice</h1>
        <p class="subtitle">Upload an invoice to detect anomalies and potential fraud</p>
      </div>
      <div class="upload-zone" id="upload-zone">
        <div class="upload-content">
          <div class="upload-icon">&#128196;</div>
          <p class="upload-text">Drag and drop an invoice file here, or click to browse</p>
          <label for="file-input" class="upload-button">Choose File</label>
          <input id="file-input" type="file" accept=".pdf,.jpg,.jpeg,.png,.txt" style="display:none" />
        </div>
      </div>
      <div id="upload-error" class="error-message" style="display:none"></div>
      <div id="analysis-results" class="analysis-results" style="display:none"></div>
    </div>
  </div>

  <div id="detail-view" class="invoice-detail">
    <div class="detail-header">
      <button type="button" class="btn btn-secondary back-button" id="back-to-list">&#8592; Back to List</button>
      <div class="header-actions">
        <span id="submitted-status" class="submitted-status" style="display:none"></span>
        <button type="button" class="btn btn-success" id="submit-erpnext">&#128230; Submit to ERPNext</button>
      </div>
    </div>
    <div id="detail-error" class="error-message" style="display:none"></div>
    <div id="detail-loading" class="loading-container">Loading invoice...</div>
    <div id="detail-content" class="detail-content" style="display:none">
      <div class="invoice-card" id="invoice-card">
        <div class="analysis-section" id="detail-analysis"></div>
        <div class="explanation-box" id="detail-explanation"><h3>Explanation</h3><p id="detail-explanation-text"></p></div>
      </div>
    </div>
  </div>

  <script>
    (function() {
      var API_BASE = 'http://localhost:8000';

      function getPathId() {
        var m = location.pathname.match(/^\/invoices\/([^/]+)/);
        return m ? m[1] : null;
      }

      function showUpload() {
        document.getElementById('upload-view').classList.add('visible');
        document.getElementById('detail-view').classList.remove('visible');
      }

      function showDetail() {
        document.getElementById('upload-view').classList.remove('visible');
        document.getElementById('detail-view').classList.add('visible');
      }

      function renderUploadResults(data) {
        var inv = data.parsed_data || {};
        var analysis = {
          is_suspicious: data.is_suspicious || false,
          risk_score: data.risk_score != null ? data.risk_score : 0,
          explanation: data.anomaly_explanation || 'No explanation.',
          anomalies: []
        };
        var riskClass = analysis.risk_score >= 70 ? 'high' : analysis.risk_score >= 50 ? 'medium' : 'low';
        var riskLabel = analysis.is_suspicious ? '&#9888;&#65039; SUSPICIOUS' : '&#10003; SAFE';
        var items = (inv.items || []).map(function(item) {
          return '<tr><td>' + (item.name || '') + '</td><td>' + item.quantity + '</td><td>$' + (item.unit_price || 0).toFixed(2) + '</td><td>$' + (item.total_price || 0).toFixed(2) + '</td></tr>';
        }).join('');
        var html = '<div class="result-card ' + (analysis.is_suspicious ? 'suspicious' : 'safe') + '">' +
          '<div class="result-header"><h2>Analysis Results</h2><div class="risk-badge ' + riskClass + '">' + riskLabel + '</div></div>' +
          '<div class="risk-score ' + riskClass + '">Risk Score: ' + analysis.risk_score + '/100</div>' +
          '<div class="explanation-box"><h3>Explanation</h3><p>' + (analysis.explanation || '').replace(/</g, '&lt;') + '</p></div>' +
          '<div class="invoice-details"><h3>Invoice Details</h3><div class="details-grid">' +
          '<div class="detail-item"><span class="detail-label">Vendor:</span><span class="detail-value">' + (inv.vendor_name || '') + '</span></div>' +
          '<div class="detail-item"><span class="detail-label">Invoice #:</span><span class="detail-value">' + (inv.invoice_number || '') + '</span></div>' +
          '<div class="detail-item"><span class="detail-label">Date:</span><span class="detail-value">' + (inv.invoice_date ? new Date(inv.invoice_date).toLocaleDateString() : '') + '</span></div>' +
          '<div class="detail-item"><span class="detail-label">Total Amount:</span><span class="detail-value">$' + (inv.total_amount || 0).toFixed(2) + ' ' + (inv.currency || '') + '</span></div>' +
          '</div><div class="items-table"><h4>Items</h4><table><thead><tr><th>Item Name</th><th>Quantity</th><th>Unit Price</th><th>Total</th></tr></thead><tbody>' + items + '</tbody></table></div>' +
          '<div class="action-buttons">' +
          '<button type="button" class="btn btn-primary" data-invoice-id="' + (data.id || '') + '">View Details</button>' +
          '<button type="button" class="btn btn-secondary" id="upload-another-btn">Upload Another</button>' +
          '</div></div></div>';
        var el = document.getElementById('analysis-results');
        el.innerHTML = html;
        el.style.display = 'block';
        document.getElementById('upload-error').style.display = 'none';
        el.querySelector('[data-invoice-id]').addEventListener('click', function() {
          location.href = '/invoices/' + this.getAttribute('data-invoice-id');
        });
        document.getElementById('upload-another-btn').addEventListener('click', function() {
          el.style.display = 'none';
          el.innerHTML = '';
          document.getElementById('file-input').value = '';
        });
      }

      function showUploadError(msg) {
        var el = document.getElementById('upload-error');
        el.innerHTML = '<strong>&#9888;&#65039; Error:</strong> ' + (msg || 'Unknown error') + '<br><small style="margin-top:10px;display:block">Make sure the backend server is running at http://localhost:8000</small>';
        el.style.display = 'block';
        document.getElementById('analysis-results').style.display = 'none';
      }

      // Upload zone: file input and drag-drop
      var zone = document.getElementById('upload-zone');
      var fileInput = document.getElementById('file-input');
      zone.addEventListener('click', function(e) { if (e.target !== fileInput) fileInput.click(); });
      zone.addEventListener('dragover', function(e) { e.preventDefault(); zone.classList.add('dragging'); });
      zone.addEventListener('dragleave', function(e) { e.preventDefault(); zone.classList.remove('dragging'); });
      zone.addEventListener('drop', function(e) {
        e.preventDefault();
        zone.classList.remove('dragging');
        var file = e.dataTransfer && e.dataTransfer.files[0];
        if (file) doUpload(file);
      });
      fileInput.addEventListener('change', function() {
        var file = fileInput.files && fileInput.files[0];
        if (file) doUpload(file);
      });

      function doUpload(file) {
        var zoneEl = document.getElementById('upload-zone');
        zoneEl.classList.add('processing');
        zoneEl.querySelector('.upload-text').textContent = 'Processing invoice...';
        var formData = new FormData();
        formData.append('file', file);
        fetch(API_BASE + '/api/invoices/upload', { method: 'POST', body: formData })
          .then(function(r) {
            if (!r.ok) return r.json().then(function(d) { throw new Error(d.detail || d.message || r.statusText); });
            return r.json();
          })
          .then(function(data) {
            zoneEl.classList.remove('processing');
            zoneEl.querySelector('.upload-text').textContent = 'Drag and drop an invoice file here, or click to browse';
            renderUploadResults(data);
          })
          .catch(function(err) {
            zoneEl.classList.remove('processing');
            zoneEl.querySelector('.upload-text').textContent = 'Drag and drop an invoice file here, or click to browse';
            showUploadError(err.message || 'Failed to process invoice.');
          });
      }

      // Detail view
      document.getElementById('back-to-list').addEventListener('click', function() { location.href = '/'; });
      document.getElementById('submit-erpnext').addEventListener('click', function() {
        var id = getPathId();
        if (!id || !window._detailInvoice) return;
        if (!window.confirm('Are you sure you want to submit this invoice to ERPNext?')) return;
        var btn = this;
        btn.disabled = true;
        btn.textContent = 'Submitting...';
        fetch(API_BASE + '/api/invoices/' + id + '/submit-to-erpnext', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({}) })
          .then(function(r) {
            if (!r.ok) return r.json().then(function(d) { throw new Error(d.detail || d.message || r.statusText); });
            return r.json();
          })
          .then(function(data) {
            window._detailInvoice = data;
            var st = document.getElementById('submitted-status');
            st.style.display = 'inline-block';
            st.innerHTML = '&#10003; Submitted to ERPNext' + (data.erpnext_invoice_name ? ' <span class="erpnext-name">(' + data.erpnext_invoice_name + ')</span>' : '');
            btn.style.display = 'none';
            btn.disabled = false;
            btn.textContent = '&#128230; Submit to ERPNext';
            if (window.alert) window.alert('Invoice submitted successfully to ERPNext!\nERPNext Invoice: ' + (data.erpnext_invoice_name || 'N/A'));
          })
          .catch(function(err) {
            document.getElementById('detail-error').style.display = 'block';
            document.getElementById('detail-error').innerHTML = '<strong>Error:</strong> ' + (err.message || 'Failed to submit');
            btn.disabled = false;
            btn.textContent = '&#128230; Submit to ERPNext';
          });
      });

      function renderDetail(invoice) {
        window._detailInvoice = invoice;
        var inv = invoice.parsed_data || {};
        document.getElementById('detail-loading').style.display = 'none';
        document.getElementById('detail-content').style.display = 'block';
        document.getElementById('detail-explanation-text').textContent = invoice.anomaly_explanation || 'No explanation.';
        if (invoice.risk_score != null) {
          var riskClass = invoice.risk_score >= 70 ? 'high' : invoice.risk_score >= 50 ? 'medium' : 'low';
          document.getElementById('detail-analysis').innerHTML = '<div class="analysis-header"><h2>Analysis Results</h2><div class="risk-badge-large ' + riskClass + '">Risk Score: ' + invoice.risk_score + '/100</div></div>';
          document.getElementById('detail-analysis').style.display = 'block';
        }
        if (invoice.submitted_to_erpnext) {
          var st = document.getElementById('submitted-status');
          st.style.display = 'inline-block';
          st.innerHTML = '&#10003; Submitted to ERPNext' + (invoice.erpnext_invoice_name ? ' <span class="erpnext-name">(' + invoice.erpnext_invoice_name + ')</span>' : '');
          document.getElementById('submit-erpnext').style.display = 'none';
        }
      }

      function loadDetail(id) {
        showDetail();
        document.getElementById('detail-loading').style.display = 'block';
        document.getElementById('detail-content').style.display = 'none';
        document.getElementById('detail-error').style.display = 'none';
        document.getElementById('submitted-status').style.display = 'none';
        document.getElementById('submit-erpnext').style.display = 'inline-block';
        document.getElementById('submit-erpnext').textContent = '&#128230; Submit to ERPNext';
        fetch(API_BASE + '/api/invoices/' + encodeURIComponent(id))
          .then(function(r) {
            if (!r.ok) return r.json().then(function(d) { throw new Error(d.detail || d.message || r.statusText); });
            return r.json();
          })
          .then(renderDetail)
          .catch(function(err) {
            document.getElementById('detail-loading').style.display = 'none';
            document.getElementById('detail-error').style.display = 'block';
            document.getElementById('detail-error').innerHTML = '<strong>Error:</strong> ' + (err.message || 'Failed to load');
          });
      }

      // Route on load
      if (location.pathname === '/' || location.pathname === '') {
        showUpload();
      } else {
        var id = getPathId();
        if (id) loadDetail(id);
        else showUpload();
      }
    })();
  </script>
</body>
</html>
